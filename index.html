const express = require("express");
const fetch = require("node-fetch");
const app = express();

app.get("/p2p", async (req, res) => {
  try {
    // BINANCE P2P KES
    const binance = await fetch(
      "https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          asset: "USDT",
          fiat: "KES",
          tradeType: "BUY",
          page: 1,
          rows: 1
        })
      }
    ).then(r => r.json());

    const binanceBuy = parseFloat(binance.data[0].adv.price);

    const binanceSellReq = await fetch(
      "https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          asset: "USDT",
          fiat: "KES",
          tradeType: "SELL",
          page: 1,
          rows: 1
        })
      }
    ).then(r => r.json());

    const binanceSell = parseFloat(binanceSellReq.data[0].adv.price);

    // OKX P2P KES
    const okx = await fetch(
      "https://www.okx.com/v3/c2c/tradingOrders/books",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          side: "buy",
          baseCurrency: "USDT",
          quoteCurrency: "KES",
          page: 1,
          limit: 1
        })
      }
    ).then(r => r.json());

    const okxBuy = parseFloat(okx.data.buy[0].price);
    const okxSell = parseFloat(okx.data.sell[0].price);

    res.json({
      binance: { buy: binanceBuy, sell: binanceSell },
      okx: { buy: okxBuy, sell: okxSell }
    });

  } catch (e) {
    res.status(500).json({ error: "Fetch failed" });
  }
});

app.listen(3000, () => console.log("Backend running"));
